<html>
<head>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/snap.svg/0.5.1/snap.svg-min.js"></script>
</head>
<body>
    <div>smaller letter must have a underscore prefix. </div><br/>
    <div>smaller alphabet: _a.svg </div><br/>
    <div>capital alphabet: A.svg </div><br/>
    <div>
        <span>Upload File:</span>
        <input type="file" id="upload-svg" multiple />
    </div>
    <div id="previewItem">




    </div>

    <div>
        <button disabled id="downloadBTN">Download</button>
    </div>
</body>


<script src="https://cdn.jsdelivr.net/npm/opentype.js"></script>
<script src="./js/raphaelv2.1.1.min.js"></script>
<script src="./js/OpenType/bbox.js"></script>
<script src="./js/OpenType/Path.js"></script>
<script src="https://code.jquery.com/jquery-latest.min.js"></script>
<script>
    let GLOBALS = {
        fontOptions: {
            autoResize: true,
            emSquare: 100
        }
    }
    function getPath(e, t) {
        if ($(e).is("line"))
            return userModifications(e, new Line(e).convertLineToPath(), t);
        if ($(e).is("path"))
      
            return   convertTransalteToPath(e);
        if ($(e).is("polygon") || $(e).is("polyline"))
            return userModifications(e, convertPolyToPath(e), t);
        if ($(e).is("rect"))
            return userModifications(e, convertRectToPath(e), t);
        if ($(e).is("circle") || $(e).is("ellipse"))
            return userModifications(e, convertCircleToPath(e), t)
    }
    function Line(e) {
        this.line = e,
            this.strokeWidth = e.getAttribute("stroke-width"),
            this.x1 = parseFloat(e.getAttribute("x1")),
            this.x2 = parseFloat(e.getAttribute("x2")),
            this.y1 = parseFloat(e.getAttribute("y1")),
            this.y2 = parseFloat(e.getAttribute("y2"))
    }
    function convertPolyToPath(e) {
        var t, i = e.getAttribute("points").split(/\s+|,/), a = "M" + i.shift() + "," + i.shift() + "L" + i.join(" ");
        return "polygon" == e.tagName && (a += "z"),
            a
    }
    function convertCircleToPath(e) {
        var t = e.getAttribute("cx")
            , i = e.getAttribute("cy")
            , a = e.getAttribute("rx")
            , n = e.getAttribute("ry")
            , o = e.getAttribute("r");
        o > 0 && (a = o,
            n = o);
        var r = "M" + (t - a) + "," + i;
        return r += "a" + a + "," + n + " 0 1,0 " + 2 * a + ",0",
            r += "a" + a + "," + n + " 0 1,0 " + -2 * a + ",0"
    }
    function convertRectToPath(e) {
        var t = e.ownerSVGElement.namespaceURI
            , i = document.createElementNS(t, "path")
            , a = e.getAttribute("height")
            , n = e.getAttribute("width")
            , o = parseFloat(e.getAttribute("x"))
            , r = parseFloat(e.getAttribute("y"))
            , s = e.getAttribute("rx")
            , l = e.getAttribute("ry")
            , c = a - 2 * (null != l ? l : 0)
            , p = n - 2 * (null != s ? s : 0)
            , i = "M" + o + "," + (r + (null != l ? l : 0)) + "v" + c + (null != s ? "a" + s + "," + l + " 0 0 0 " + s + "," + l : "") + "h" + p + (null != s ? "a" + s + "," + l + " 0 0 0 " + (s - l) : "") + "v" + -c + (null != s ? "a" + s + "," + l + " 0 0 0 " + -s + "," + -l : "") + "h" + -p + (null != s ? "a" + s + "," + l + " 0 0 0 " + -s + "," + l : "");
        return i
    }
    function roundToDecimal(e, t) {
        var i = Math.pow(10, t);
        return Math.round(e * i) / i
    }
    function userModifications(e, t, i) {
        var a = e.getAttribute("class") || ""
            , n = parseFloat(e.getAttribute("data-left")) || 0
            , o = parseFloat(e.getAttribute("data-top")) || 0
            , r = parseInt(e.getAttribute("data-rotate")) || 0
            , s = e.getAttribute("data-flip") || ""
            , l = e.getAttribute("data-scaleX") || 1
            , c = e.getAttribute("data-scaleY") || 1
            , p = "";

        return t = Raphael.transformPath(t, p)
    }

    function convertTransalteToPath(elm) {
        let pathData = elm.getAttribute("d");
        let translate = elm.getAttribute("transform");
        if (translate == null) return pathData;
        var translateValues = translate.match(/-?\d+/g);

        var tx = parseFloat(translateValues[0]);
        var ty = parseFloat(translateValues[1]);
        var matrixString = "matrix(1 0 0 1 " + tx + " " + ty + ")";

        // Apply the matrix to the path data
        var modifiedPathData = Snap.path.map(pathData, Snap.matrix(1, 0, 0, 1, tx, ty));
    
        return modifiedPathData.toString();
    }

    function createPath(e) {
        var t = ""
            , i = 0;
        if ($(e).find("svg").find("*").each(function (e, a) {
            var n = getPath(a);
            $.trim(n).length > 0 && (t += " " + n,
                i++)
        }),
            "" != (t = $.trim(t))) {
            if (GLOBALS.fontOptions.autoResize) {
                t = Raphael.pathToRelative(t);
                var a = Raphael.pathBBox(t)
                    , n = a.x2 - a.x
                    , o = a.y2 - a.y
                    , r = GLOBALS.fontOptions.emSquare / n
                    , s = GLOBALS.fontOptions.emSquare / o
                    , l = s < r ? s : r;
                console.log(l),
                    t = Raphael.transformPath(t, "s" + l + ",-" + l);
                var c = Raphael.pathBBox(t)
                    , p = -c.x + (GLOBALS.fontOptions.emSquare - parseInt(c.width)) / 2
                    , d = -c.y + (GLOBALS.fontOptions.emSquare - parseInt(c.height)) / 2;
                t = Raphael.transformPath(t, "T" + p + "," + d)
            } else
                t = Raphael.transformPath(t, "s1,-1");
            (t = userModifications($(e).find("svg")[0], t)).forEach(function (e, i) {
                e.forEach(function (e, a) {
                    if (isNaN(e))
                        return !0;
                    t[i][a] = parseFloat(e.toFixed(3))
                })
            })
        }
        t = Raphael.transformPath(t, "s1,-1")
        return t
    }
</script>

<script>
    let allFiles = []
    let downloadBTN = $("#downloadBTN")[0]
    $("#upload-svg").on("change", function (e) {
        allFiles = [];
        for (let i = 0; i < e.target.files.length; i++) {
            const file = e.target.files[i];
            if (file) {
                var reader = new FileReader();
                reader.onload = function (e) {
                    var contents = e.target.result;

                    if (file.type.indexOf('svg') > 0) {
                        var newElm = document.createElement("svg")
                        newElm.innerHTML = contents;
                        let file_name = file.name.replaceAll("_", "").replaceAll(".svg", "");
                        let path = createPath(newElm).toString();
                        allFiles.push({
                            name: file_name,
                            path: path
                        })
                    } else {
                    }

                }
                reader.readAsText(file);
            }
        }
        setTimeout(() => {
            render()
        }, 800)
    });
    $("#downloadBTN").on("click", function (e) { download() })


    function render() {
      
        generateFont()

    }

</script>
<script>

function convertPathsToOnePath(svgElement) {
  // Use Snap.svg to manipulate SVG paths
  const paper = Snap(svgElement);
  const paths = paper.selectAll('path');

  // Combine multiple paths into a single path
  const combinedPath = paths.items.reduce((combined, path) => {
    const pathData = Snap.path.toRelative(path);
    combined += pathData;
    return combined;
  }, '');

  return combinedPath;
}


    function generateFont() {
  const svgFileInput = document.getElementById('upload-svg');

  // Loop through uploaded files
  for (const file of svgFileInput.files) {
    const reader = new FileReader();

    reader.onload = function (event) {
      const svgData = event.target.result;
      
      var newElm = document.createElement("svg")
    newElm.innerHTML = svgData;
    let file_name = file.name.replaceAll("_", "").replaceAll(".svg", "");

    const combinedPathData = convertPathsToOnePath(newElm);
    const elmPath = new Path();
            elmPath.fromSVG(combinedPathData.replaceAll("r",""))
    const glyph =  new opentype.Glyph({
        name: file_name,
        unicode:file_name.charCodeAt(0), // Use the Unicode of the first character
                advanceWidth: 100,
        path: elmPath,
      });
      // Create a new font for each letter (adjust Unicode accordingly)
      const font = new opentype.Font({
        familyName: 'DynamicFont',
        styleName: 'Regular',
        unitsPerEm: 1000,
            ascender: 100,
            descender: -100,
            
            glyphs:[glyph]
      });

      

      // Display the generated font
      const fontCanvas = document.createElement('canvas');
      fontCanvas.width = 650; // Adjust the size as needed
      fontCanvas.height = 650;
      const ctx = fontCanvas.getContext('2d');
      glyph.draw(ctx, 10, 40, 40); // Adjust positioning and size

      $("#previewItem")[0].appendChild(fontCanvas);
    };

    reader.readAsText(file);
  }
}
</script>

<style>
    #previewItem {
        display: flex;
        gap: 2rem;
    }

    .svgs {
        display: flex;
        flex-direction: column;
        align-items: center;
        width: fit-content;
        margin-bottom: 2rem;
    }

    svg {
        width: 6rem;
        height: 6rem;
        border: 1px solid;
        padding: 2rem;
    }
</style>

</html>